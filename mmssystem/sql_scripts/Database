CREATE DATABASE IF NOT EXISTS mms;
USE mms;
CREATE TABLE Departments (
    department_id INT AUTO_INCREMENT PRIMARY KEY,
    department_name VARCHAR(255) NOT NULL,
    department_code VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    INDEX idx_dept_code (department_code),
    INDEX idx_dept_deleted (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    employee_code VARCHAR(50) NOT NULL,
    department_id INT NOT NULL,
    status ENUM('Active', 'Inactive') NOT NULL DEFAULT 'Active',
    otp_code VARCHAR(6) NULL,
    otp_expiry TIMESTAMP NULL,
    otp_used BOOLEAN DEFAULT FALSE,
    otp_attempts INT DEFAULT 0,
    last_otp_request_time DATETIME,
    last_login DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (department_id) REFERENCES Departments(department_id) ON DELETE RESTRICT,
    UNIQUE KEY uq_email_deleted (email, deleted_at),
    UNIQUE KEY uq_employee_code_deleted (employee_code, deleted_at),
    INDEX idx_users_department (department_id),
    INDEX idx_users_status (status, deleted_at),
    INDEX idx_users_created (created_at),
    INDEX idx_users_login (last_login)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Roles (
    role_id INT AUTO_INCREMENT PRIMARY KEY,
    role_name VARCHAR(255) NOT NULL UNIQUE,
    INDEX idx_role_name (role_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE User_Roles (
    user_id INT NOT NULL,
    role_id INT NOT NULL,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES Roles(role_id) ON DELETE CASCADE,
    INDEX idx_role_users (role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE User_Profile (
    profile_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL UNIQUE,
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    gender ENUM('Male', 'Female', 'Other'),
    dob DATE,
    phone_number VARCHAR(50),
    address TEXT,
    avatar_url VARCHAR(255) DEFAULT NULL,
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE token_blacklist (
    id INT AUTO_INCREMENT PRIMARY KEY,
    token VARCHAR(500) NOT NULL UNIQUE,
    user_id INT NOT NULL,
    blacklisted_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
    INDEX idx_token (token),
    INDEX idx_expires (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE menu_items (
    menu_id INT AUTO_INCREMENT PRIMARY KEY,
    menu_key VARCHAR(50) NOT NULL UNIQUE,
    menu_label VARCHAR(100) NOT NULL,
    menu_path VARCHAR(255) NOT NULL,
    menu_icon VARCHAR(50),
    parent_id INT DEFAULT NULL,
    display_order INT DEFAULT 0,
    INDEX idx_menu_key (menu_key),
    INDEX idx_display_order (display_order),
    INDEX idx_parent_id (parent_id),
    FOREIGN KEY (parent_id) REFERENCES menu_items(menu_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE role_menus (
    role_id INT NOT NULL,
    menu_id INT NOT NULL,
    PRIMARY KEY (role_id, menu_id),
    FOREIGN KEY (role_id) REFERENCES Roles(role_id) ON DELETE CASCADE,
    FOREIGN KEY (menu_id) REFERENCES menu_items(menu_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE permissions (
    permission_id INT AUTO_INCREMENT PRIMARY KEY,
    permission_key VARCHAR(100) NOT NULL UNIQUE,
    permission_name VARCHAR(100) NOT NULL,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    INDEX idx_permission_key (permission_key),
    INDEX idx_resource_action (resource, action)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE role_permissions (
    role_id INT NOT NULL,
    permission_id INT NOT NULL,
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES Roles(role_id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE user_permissions (
    user_id INT NOT NULL,
    permission_id INT NOT NULL,
    expires_at DATETIME NULL,
    PRIMARY KEY (user_id, permission_id),
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE,
    INDEX idx_expires (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================================
-- MASTER DATA: Addresses, Contacts, Customers, Vendors
-- =====================================================

CREATE TABLE Addresses (
    address_id INT AUTO_INCREMENT PRIMARY KEY,
    street VARCHAR(255),
    country VARCHAR(100),
    province_code VARCHAR(20),
    province_name VARCHAR(100),
    ward_code VARCHAR(20),
    ward_name VARCHAR(100),
    INDEX idx_province (province_code),
    INDEX idx_ward (ward_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Contacts (
    contact_id INT AUTO_INCREMENT PRIMARY KEY,
    phone VARCHAR(50),
    email VARCHAR(100),
    website VARCHAR(255),
    INDEX idx_phone (phone),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Customers (
    customer_id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    customer_code VARCHAR(255) NOT NULL UNIQUE,
    address_id INT,
    contact_id INT,
    note TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (address_id) REFERENCES Addresses(address_id) ON DELETE SET NULL,
    FOREIGN KEY (contact_id) REFERENCES Contacts(contact_id) ON DELETE SET NULL,
    INDEX idx_customer_name (first_name, last_name),
    INDEX idx_customer_code (customer_code),
    INDEX idx_customer_deleted (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Vendors (
    vendor_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    vendor_code VARCHAR(255) NOT NULL UNIQUE,
    address_id INT,
    contact_id INT,
    note TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (address_id) REFERENCES Addresses(address_id) ON DELETE SET NULL,
    FOREIGN KEY (contact_id) REFERENCES Contacts(contact_id) ON DELETE SET NULL,
    INDEX idx_vendor_code (vendor_code),
    INDEX idx_vendor_name (name),
    INDEX idx_vendor_deleted (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================================
-- PRODUCT & INVENTORY
-- =====================================================

CREATE TABLE Product_Categories (
    category_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description VARCHAR(500) DEFAULT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    INDEX idx_category_name (name),
    INDEX idx_category_deleted (deleted_at),
    INDEX idx_category_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Products (
    product_id INT AUTO_INCREMENT PRIMARY KEY,
    sku VARCHAR(50) NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    uom VARCHAR(50),
    size DECIMAL(10, 2) DEFAULT NULL,
    purchase_price DECIMAL(18, 2),
    selling_price DECIMAL(18, 2),
    status VARCHAR(50) NOT NULL DEFAULT 'In Stock',
    image_url VARCHAR(255),
    category_id INT,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (category_id) REFERENCES Product_Categories(category_id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_product_sku (sku),
    INDEX idx_product_name (name),
    INDEX idx_product_category (category_id),
    INDEX idx_product_status (status, deleted_at),
    UNIQUE KEY uq_product_sku_deleted (sku, deleted_at),
    UNIQUE KEY uq_product_name_deleted (name, deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Warehouses (
    warehouse_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) NOT NULL UNIQUE,
    location VARCHAR(255),
    status ENUM('Active', 'Inactive') NOT NULL DEFAULT 'Active',
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_warehouse_name (name),
    INDEX idx_warehouse_status (status, deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Warehouse_Stock (
    warehouse_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity DECIMAL(18, 2) NOT NULL DEFAULT 0,
    PRIMARY KEY (warehouse_id, product_id),
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE CASCADE,
    INDEX idx_stock_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================================
-- PURCHASE FLOW
-- =====================================================

CREATE TABLE Purchase_Requisitions (
    requisition_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    requisition_no VARCHAR(30) UNIQUE NOT NULL,
    requisition_date DATE DEFAULT (CURRENT_DATE),
    requester_id INT NOT NULL,
    purpose TEXT NOT NULL,
    status ENUM('Draft', 'Pending', 'Approved', 'Rejected', 'Cancelled', 'Converted') DEFAULT 'Draft',
    approver_id INT,
    approved_at DATETIME,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,

    CONSTRAINT fk_pr_requester FOREIGN KEY (requester_id) REFERENCES Users(user_id) ON DELETE RESTRICT,
    CONSTRAINT fk_pr_approver FOREIGN KEY (approver_id) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_pr_created_by FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_pr_updated_by FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,

    INDEX idx_pr_no (requisition_no),
    INDEX idx_pr_status (status, deleted_at),
    INDEX idx_pr_requester (requester_id),
    INDEX idx_pr_approver (approver_id),
    INDEX idx_pr_created_at (created_at),
    INDEX idx_pr_date (requisition_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Purchase_Requisition_Items (
    pri_id INT AUTO_INCREMENT PRIMARY KEY,
    requisition_id BIGINT NOT NULL,
    product_id INT,
    product_name VARCHAR(255),
    requested_qty DECIMAL(18, 2) NOT NULL,
    unit VARCHAR(50),
    delivery_date DATE NOT NULL,
    note TEXT,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,

    CONSTRAINT fk_pri_requisition FOREIGN KEY (requisition_id) REFERENCES Purchase_Requisitions(requisition_id) ON DELETE CASCADE,
    CONSTRAINT fk_pri_product FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE SET NULL,
    CONSTRAINT fk_pri_created_by FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_pri_updated_by FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,

    INDEX idx_pri_requisition (requisition_id),
    INDEX idx_pri_product (product_id),
    INDEX idx_pri_delivery_date (delivery_date),
    INDEX idx_pri_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE RFQs (
    rfq_id INT AUTO_INCREMENT PRIMARY KEY,
    rfq_no VARCHAR(30) UNIQUE NOT NULL,
    requisition_id BIGINT,
    issue_date DATE,
    due_date DATE,
    status ENUM('Draft', 'Pending', 'Sent', 'Completed', 'Closed', 'Cancelled') DEFAULT 'Draft',
    selected_vendor_id INT,
    created_by INT,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    CONSTRAINT fk_rfq_requisition
      FOREIGN KEY (requisition_id) REFERENCES Purchase_Requisitions(requisition_id) ON DELETE CASCADE,
    CONSTRAINT fk_rfq_created_by
      FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_rfq_selected_vendor
      FOREIGN KEY (selected_vendor_id) REFERENCES Vendors(vendor_id) ON DELETE SET NULL,
    INDEX idx_rfq_no (rfq_no),
    INDEX idx_rfq_status (status, deleted_at),
    INDEX idx_rfq_requisition (requisition_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE RFQ_Items (
    rfq_item_id INT AUTO_INCREMENT PRIMARY KEY,
    rfq_id INT NOT NULL,
    pri_id INT,
    product_id INT,
    product_code VARCHAR(50),
    product_name VARCHAR(255),
    spec TEXT,
    uom VARCHAR(50),
    quantity DECIMAL(18, 2) NOT NULL,
    delivery_date DATE,
    target_price DECIMAL(18, 2) DEFAULT 0,
    price_unit DECIMAL(10, 2) DEFAULT 1,
    note TEXT,
    CONSTRAINT fk_rfq_items_rfq
      FOREIGN KEY (rfq_id) REFERENCES RFQs(rfq_id) ON DELETE CASCADE,
    CONSTRAINT fk_rfq_items_pri
      FOREIGN KEY (pri_id) REFERENCES Purchase_Requisition_Items(pri_id) ON DELETE SET NULL,
    CONSTRAINT fk_rfq_items_product
      FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE SET NULL,
    INDEX idx_rfq_item_rfq (rfq_id),
    INDEX idx_rfq_item_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE RFQ_Vendors (
    rfq_id INT NOT NULL,
    vendor_id INT NOT NULL,
    status ENUM('Invited', 'Quoted', 'Declined') DEFAULT 'Invited',
    PRIMARY KEY (rfq_id, vendor_id),
    CONSTRAINT fk_rfq_vendors_rfq
      FOREIGN KEY (rfq_id) REFERENCES RFQs(rfq_id) ON DELETE CASCADE,
    CONSTRAINT fk_rfq_vendors_vendor
      FOREIGN KEY (vendor_id) REFERENCES Vendors(vendor_id) ON DELETE CASCADE,
    INDEX idx_rfq_vendor_vendor (vendor_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE Purchase_Quotations (
    pq_id INT AUTO_INCREMENT PRIMARY KEY,
    pq_no VARCHAR(30) UNIQUE NOT NULL,
    rfq_id INT NOT NULL,
    vendor_id INT NOT NULL,
    pq_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    valid_until DATE,
    is_tax_included TINYINT(1) DEFAULT 0,
    delivery_terms VARCHAR(255),
    payment_terms VARCHAR(255),
    lead_time_days INT,
    warranty_months INT,
    header_discount DECIMAL(18, 2) DEFAULT 0,
    shipping_cost DECIMAL(18, 2) DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    status ENUM('Draft', 'Sent', 'Pending', 'Approved', 'Rejected', 'Ordered') DEFAULT 'Pending',
    created_by INT,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (rfq_id) REFERENCES RFQs(rfq_id) ON DELETE CASCADE,
    FOREIGN KEY (vendor_id) REFERENCES Vendors(vendor_id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    UNIQUE KEY uk_pq_rfq_vendor (rfq_id, vendor_id),
    INDEX idx_pq_no (pq_no),
    INDEX idx_pq_status (status, deleted_at),
    INDEX idx_pq_rfq (rfq_id),
    INDEX idx_pq_vendor (vendor_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Purchase_Quotation_Items (
    pq_item_id INT AUTO_INCREMENT PRIMARY KEY,
    pq_id INT NOT NULL,
    rfq_item_id INT NOT NULL,
    product_id INT,
    quantity DECIMAL(18, 2) NOT NULL,
    unit_price DECIMAL(18, 2) NOT NULL,
    discount_percent DECIMAL(5, 2) DEFAULT 0,
    tax_rate DECIMAL(5, 2),
    tax_amount DECIMAL(18, 2),
    line_total DECIMAL(18, 2) NOT NULL,
    remark TEXT,
    CONSTRAINT fk_pqi_pq
      FOREIGN KEY (pq_id) REFERENCES Purchase_Quotations(pq_id) ON DELETE CASCADE,
    CONSTRAINT fk_pqi_rfq_item
      FOREIGN KEY (rfq_item_id) REFERENCES RFQ_Items(rfq_item_id) ON DELETE CASCADE,
    CONSTRAINT fk_pqi_product
      FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE SET NULL,
    INDEX idx_pqi_pq (pq_id),
    INDEX idx_pqi_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Purchase_Orders (
    order_id INT AUTO_INCREMENT PRIMARY KEY,
    po_no VARCHAR(30) NOT NULL,
    vendor_id INT NOT NULL,
    pq_id INT,
    order_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Pending', 'Approved', 'Sent', 'Completed', 'Cancelled') DEFAULT 'Pending',
    approval_status ENUM('Pending', 'Approved', 'Rejected') DEFAULT 'Pending',
    approver_id INT,
    approved_at DATETIME,
    payment_terms VARCHAR(255),
    delivery_date DATETIME,
    shipping_address TEXT,
    header_discount DECIMAL(5, 2) DEFAULT 0,
    total_before_tax DECIMAL(18, 2) DEFAULT 0,
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    total_after_tax DECIMAL(18, 2) DEFAULT 0,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (vendor_id) REFERENCES Vendors(vendor_id) ON DELETE RESTRICT,
    FOREIGN KEY (pq_id) REFERENCES Purchase_Quotations(pq_id) ON DELETE SET NULL,
    FOREIGN KEY (approver_id) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    UNIQUE KEY uk_po_pq (pq_id),
    UNIQUE KEY uk_po_no_active (po_no, deleted_at),
    INDEX idx_po_status (status, approval_status, deleted_at),
    INDEX idx_po_vendor (vendor_id),
    INDEX idx_po_pq (pq_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Purchase_Order_Items (
    poi_id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NULL,
    pq_item_id INT,
    product_id INT NOT NULL,
    uom VARCHAR(50),
    quantity DECIMAL(18, 2) NOT NULL,
    received_qty DECIMAL(18, 2) NOT NULL DEFAULT 0,
    invoiced_qty DECIMAL(18, 2) NOT NULL DEFAULT 0,
    unit_price DECIMAL(18, 2) NOT NULL,
    discount_percent DECIMAL(5, 2) DEFAULT 0,
    tax_rate DECIMAL(5, 2),
    tax_amount DECIMAL(18, 2),
    line_total DECIMAL(18, 2) NOT NULL,
    delivery_date DATE,
    note TEXT,
    CONSTRAINT fk_poi_order
      FOREIGN KEY (order_id) REFERENCES Purchase_Orders(order_id) ON DELETE CASCADE,
    CONSTRAINT fk_poi_pq_item
      FOREIGN KEY (pq_item_id) REFERENCES Purchase_Quotation_Items(pq_item_id) ON DELETE SET NULL,
    CONSTRAINT fk_poi_product
      FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    INDEX idx_poi_order (order_id),
    INDEX idx_poi_product (product_id),
    INDEX idx_poi_qty_tracking (order_id, received_qty, invoiced_qty)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================================
-- INBOUND DELIVERY (CHỨNG TỪ YÊU CẦU NHẬN HÀNG)
-- =====================================================

CREATE TABLE Inbound_Deliveries (
    inbound_delivery_id INT AUTO_INCREMENT PRIMARY KEY,
    inbound_delivery_no VARCHAR(30) UNIQUE NOT NULL,
    order_id INT NOT NULL,
    warehouse_id INT NOT NULL,
    planned_date DATETIME,
    vendor_id INT NOT NULL,
    shipping_address TEXT,
    status ENUM('Draft', 'Pending', 'Completed', 'Cancelled') DEFAULT 'Draft',
    notes TEXT,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,

    CONSTRAINT fk_inbound_delivery_order 
      FOREIGN KEY (order_id) REFERENCES Purchase_Orders(order_id) ON DELETE RESTRICT,
    CONSTRAINT fk_inbound_delivery_warehouse 
      FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    CONSTRAINT fk_inbound_delivery_vendor 
      FOREIGN KEY (vendor_id) REFERENCES Vendors(vendor_id) ON DELETE RESTRICT,
    CONSTRAINT fk_inbound_delivery_created_by 
      FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_inbound_delivery_updated_by 
      FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,

    INDEX idx_inbound_delivery_no (inbound_delivery_no),
    INDEX idx_inbound_delivery_status (status, deleted_at),
    INDEX idx_inbound_delivery_order (order_id),
    INDEX idx_inbound_delivery_warehouse (warehouse_id),
    INDEX idx_inbound_delivery_planned_date (planned_date),
    INDEX idx_inbound_delivery_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Inbound_Delivery_Items (
    idi_id INT AUTO_INCREMENT PRIMARY KEY,
    inbound_delivery_id INT NOT NULL,
    poi_id INT NOT NULL,
    product_id INT NOT NULL,
    expected_qty DECIMAL(18, 2) NOT NULL,
    uom VARCHAR(50),
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT fk_idi_inbound_delivery 
      FOREIGN KEY (inbound_delivery_id) REFERENCES Inbound_Deliveries(inbound_delivery_id) ON DELETE CASCADE,
    CONSTRAINT fk_idi_poi 
      FOREIGN KEY (poi_id) REFERENCES Purchase_Order_Items(poi_id) ON DELETE RESTRICT,
    CONSTRAINT fk_idi_product 
      FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,

    INDEX idx_idi_inbound_delivery (inbound_delivery_id),
    INDEX idx_idi_poi (poi_id),
    INDEX idx_idi_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Chi tiết sản phẩm trong đơn nhận hàng';

CREATE TABLE Goods_Receipts (
    receipt_id INT AUTO_INCREMENT PRIMARY KEY,
    receipt_no VARCHAR(30) UNIQUE NOT NULL,
    -- GR cho Purchase flow: BẮT BUỘC từ Inbound Delivery
    inbound_delivery_id INT NULL,
    warehouse_id INT NOT NULL,
    received_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Pending', 'Approved', 'Rejected') DEFAULT 'Pending',
    -- Phân loại nguồn chứng từ: nhập mua (Purchase) hay nhập trả hàng bán (SalesReturn)
    source_type ENUM('Purchase', 'SalesReturn') NOT NULL DEFAULT 'Purchase',
    -- Tham chiếu Đơn trả hàng khi là phiếu nhập hàng trả (sẽ thêm FK sau khi return_orders được tạo)
    ro_id INT NULL,
    created_by INT,
    approved_by INT,
    approved_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    CONSTRAINT fk_gr_inbound_delivery
      FOREIGN KEY (inbound_delivery_id) REFERENCES Inbound_Deliveries(inbound_delivery_id) ON DELETE RESTRICT,
    CONSTRAINT fk_gr_warehouse
      FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    CONSTRAINT fk_gr_created_by
      FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_gr_approved_by
      FOREIGN KEY (approved_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_gr_no (receipt_no),
    INDEX idx_gr_status (status, deleted_at),
    INDEX idx_gr_inbound_delivery (inbound_delivery_id),
    INDEX idx_gr_warehouse (warehouse_id),
    INDEX idx_gr_return_order (ro_id),
    INDEX idx_gr_source_type (source_type),
    -- Constraint: Purchase flow PHẢI có inbound_delivery_id
    CONSTRAINT chk_gr_source_purchase 
      CHECK (source_type != 'Purchase' OR inbound_delivery_id IS NOT NULL)
    -- Note: CHECK constraint cho SalesReturn sẽ được thêm sau khi FK được tạo
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Goods_Receipt_Items (
    gri_id INT AUTO_INCREMENT PRIMARY KEY,
    receipt_id INT NOT NULL,
    -- Dùng cho trường hợp nhập mua (purchase) - tham chiếu Inbound Delivery Item
    idi_id INT NULL,
    -- Dùng cho trường hợp nhập hàng trả bán (sales return) - FK sẽ được thêm sau khi return_order_items được tạo
    roi_id INT NULL,
    product_id INT NOT NULL,
    received_qty DECIMAL(18, 2) NOT NULL,
    accepted_qty DECIMAL(18, 2) NOT NULL DEFAULT 0,
    remark TEXT,
    CONSTRAINT fk_gri_receipt
      FOREIGN KEY (receipt_id) REFERENCES Goods_Receipts(receipt_id) ON DELETE CASCADE,
    CONSTRAINT fk_gri_idi
      FOREIGN KEY (idi_id) REFERENCES Inbound_Delivery_Items(idi_id) ON DELETE SET NULL,
    CONSTRAINT fk_gri_product
      FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    INDEX idx_gri_receipt (receipt_id),
    INDEX idx_gri_idi (idi_id),
    INDEX idx_gri_product (product_id),
    INDEX idx_gri_return_item (roi_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE AP_Invoices (
    ap_invoice_id INT AUTO_INCREMENT PRIMARY KEY,
    invoice_no VARCHAR(50) UNIQUE NOT NULL,
    vendor_id INT NOT NULL,
    order_id INT,
    receipt_id INT,
    invoice_date DATE,
    due_date DATE,
    subtotal DECIMAL(18, 2) DEFAULT 0,
    header_discount_percent DECIMAL(18, 2) DEFAULT 0,
    header_discount_amount DECIMAL(18, 2) DEFAULT 0,
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    balance_amount DECIMAL(18, 2) DEFAULT 0,
    header_discount DECIMAL(5, 2) DEFAULT 0,
    status ENUM('Unpaid', 'Partially Paid', 'Paid', 'Cancelled') DEFAULT 'Unpaid',
    notes TEXT,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    CONSTRAINT fk_api_vendor
      FOREIGN KEY (vendor_id) REFERENCES Vendors(vendor_id) ON DELETE RESTRICT,
    CONSTRAINT fk_api_order
      FOREIGN KEY (order_id) REFERENCES Purchase_Orders(order_id) ON DELETE SET NULL,
    CONSTRAINT fk_api_receipt
      FOREIGN KEY (receipt_id) REFERENCES Goods_Receipts(receipt_id) ON DELETE SET NULL,
    CONSTRAINT fk_api_created_by
      FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_api_updated_by
      FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_ap_invoice_no (invoice_no),
    INDEX idx_ap_status (status, deleted_at),
    INDEX idx_ap_vendor (vendor_id),
    INDEX idx_ap_due_date (due_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE AP_Invoice_Attachments (
    attachment_id INT AUTO_INCREMENT PRIMARY KEY,
    ap_invoice_id INT NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_url VARCHAR(500) NOT NULL,
    file_type ENUM('VENDOR_INVOICE', 'RECEIPT', 'CONTRACT', 'OTHER') DEFAULT 'VENDOR_INVOICE',
    file_size BIGINT COMMENT 'File size in bytes',
    mime_type VARCHAR(100),
    description TEXT,
    uploaded_by INT,
    uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (ap_invoice_id) REFERENCES AP_Invoices(ap_invoice_id) ON DELETE CASCADE,
    FOREIGN KEY (uploaded_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_attachment_invoice (ap_invoice_id),
    INDEX idx_attachment_type (file_type),
    INDEX idx_attachment_uploaded (uploaded_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Lưu trữ file đính kèm của hóa đơn AP (PDF, Image, etc.)';

CREATE TABLE AP_Invoice_Items (
    api_id INT AUTO_INCREMENT PRIMARY KEY,
    ap_invoice_id INT NOT NULL,
    poi_id INT,
    gri_id INT,
    description VARCHAR(255),
    uom VARCHAR(50),
    quantity DECIMAL(18, 2),
    unit_price DECIMAL(18, 2),
    discount_percent DECIMAL(5, 2) DEFAULT 0,
    tax_rate DECIMAL(5, 2),
    line_total DECIMAL(18, 2),
    CONSTRAINT fk_apii_invoice
      FOREIGN KEY (ap_invoice_id) REFERENCES AP_Invoices(ap_invoice_id) ON DELETE CASCADE,
    CONSTRAINT fk_apii_poi
      FOREIGN KEY (poi_id) REFERENCES Purchase_Order_Items(poi_id) ON DELETE SET NULL,
    CONSTRAINT fk_apii_gri
      FOREIGN KEY (gri_id) REFERENCES Goods_Receipt_Items(gri_id) ON DELETE SET NULL,
    INDEX idx_api_invoice (ap_invoice_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE AP_Payments (
    ap_payment_id INT AUTO_INCREMENT PRIMARY KEY,
    ap_invoice_id INT NOT NULL,
    payment_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    amount DECIMAL(18, 2) NOT NULL,
    method VARCHAR(50),
    reference_no VARCHAR(100),
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_app_invoice
      FOREIGN KEY (ap_invoice_id) REFERENCES AP_Invoices(ap_invoice_id) ON DELETE CASCADE,
    INDEX idx_app_invoice (ap_invoice_id),
    INDEX idx_app_date (payment_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Vendor_Balances (
    balance_id INT AUTO_INCREMENT PRIMARY KEY,
    vendor_id INT NOT NULL,
    total_invoiced DECIMAL(18, 2) DEFAULT 0 COMMENT 'Tổng tiền hóa đơn phải trả',
    total_paid DECIMAL(18, 2) DEFAULT 0 COMMENT 'Tổng tiền đã thanh toán',
    outstanding_balance DECIMAL(18, 2) DEFAULT 0 COMMENT 'Công nợ còn lại',
    last_updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (vendor_id) REFERENCES Vendors(vendor_id) ON DELETE CASCADE,
    UNIQUE KEY uk_vendor_balance (vendor_id),
    INDEX idx_vendor_balance (vendor_id),
    INDEX idx_outstanding_balance (outstanding_balance)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================================
-- SALES FLOW
-- =====================================================

CREATE TABLE Sales_Quotations (
    sq_id INT AUTO_INCREMENT PRIMARY KEY,
    quotation_no VARCHAR(30) UNIQUE NOT NULL,
    customer_id INT NOT NULL,
    quotation_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    payment_terms VARCHAR(255),
    delivery_terms VARCHAR(255),
    header_discount_percent DECIMAL(18, 2) DEFAULT 0,
    header_discount_amount DECIMAL(18, 2) DEFAULT 0,
    subtotal DECIMAL(18, 2) DEFAULT 0,
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    status ENUM('Draft', 'Active', 'Converted', 'Cancelled', 'Expired') DEFAULT 'Draft',
    created_by INT,
    updated_by INT,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id) ON DELETE RESTRICT,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_sq_no (quotation_no),
    INDEX idx_sq_status (status, deleted_at),
    INDEX idx_sq_customer (customer_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Sales_Quotation_Items (
    sqi_id INT AUTO_INCREMENT PRIMARY KEY,
    sq_id INT NOT NULL,
    product_id INT NOT NULL,
    uom VARCHAR(50),
    quantity DECIMAL(18, 2) NOT NULL,
    unit_price DECIMAL(18, 2) NOT NULL,
    discount_amount DECIMAL(18, 2) DEFAULT 0,
    tax_rate DECIMAL(5, 2),
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    line_total DECIMAL(18, 2) NOT NULL,
    note TEXT,
    FOREIGN KEY (sq_id) REFERENCES Sales_Quotations(sq_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    INDEX idx_sqi_sq (sq_id),
    INDEX idx_sqi_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Sales_Orders (
    so_id INT AUTO_INCREMENT PRIMARY KEY,
    so_no VARCHAR(30) UNIQUE NOT NULL,
    customer_id INT NOT NULL,
    sq_id INT,
    order_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Draft', 'Approved', 'Fulfilled', 'Cancelled') DEFAULT 'Draft',
    approval_status ENUM('Draft', 'Approved') DEFAULT 'Draft',
    approver_id INT,
    approved_at DATETIME,
    shipping_address TEXT,
    payment_terms VARCHAR(255),
    header_discount_percent DECIMAL(5, 2) DEFAULT 0,
    header_discount_amount DECIMAL(18, 2) DEFAULT 0,
    subtotal DECIMAL(18, 2) DEFAULT 0,
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    created_by INT,
    updated_by INT,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id) ON DELETE RESTRICT,
    FOREIGN KEY (sq_id) REFERENCES Sales_Quotations(sq_id) ON DELETE SET NULL,
    FOREIGN KEY (approver_id) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_so_no (so_no),
    INDEX idx_so_status (status, approval_status, deleted_at),
    INDEX idx_so_customer (customer_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Sales_Order_Items (
    soi_id INT AUTO_INCREMENT PRIMARY KEY,
    so_id INT NOT NULL,
    product_id INT NOT NULL,
    uom VARCHAR(50),
    quantity DECIMAL(18, 2) NOT NULL,
    unit_price DECIMAL(18, 2) NOT NULL,
    discount_amount DECIMAL(18, 2) DEFAULT 0,
    tax_rate DECIMAL(5, 2),
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    line_total DECIMAL(18, 2) NOT NULL,
    warehouse_id INT,
    note TEXT,
    FOREIGN KEY (so_id) REFERENCES Sales_Orders(so_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE SET NULL,
    INDEX idx_soi_so (so_id),
    INDEX idx_soi_product (product_id),
    INDEX idx_soi_warehouse (warehouse_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Deliveries (
    delivery_id INT AUTO_INCREMENT PRIMARY KEY,
    delivery_no VARCHAR(30) UNIQUE NOT NULL,
    so_id INT NOT NULL,
    warehouse_id INT NOT NULL,
    planned_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    actual_date DATETIME NULL,
    shipping_address TEXT,
    carrier_name VARCHAR(150),
    driver_name VARCHAR(150),
    driver_phone VARCHAR(50),
    tracking_code VARCHAR(100),
    status ENUM('Draft', 'Picked', 'Shipped', 'Delivered', 'Cancelled') DEFAULT 'Draft',
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    notes TEXT,
    FOREIGN KEY (so_id) REFERENCES Sales_Orders(so_id) ON DELETE CASCADE,
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_del_no (delivery_no),
    INDEX idx_del_status (status, deleted_at),
    INDEX idx_del_so (so_id),
    INDEX idx_del_warehouse (warehouse_id),
    INDEX idx_del_tracking (tracking_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Delivery_Items (
    di_id INT AUTO_INCREMENT PRIMARY KEY,
    delivery_id INT NOT NULL,
    soi_id INT NOT NULL,
    product_id INT NOT NULL,
    warehouse_id INT,
    ordered_qty DECIMAL(18, 2) NOT NULL DEFAULT 0,
    planned_qty DECIMAL(18, 2) NOT NULL,
    delivered_qty DECIMAL(18, 2) DEFAULT 0,
    uom VARCHAR(50),
    note TEXT,
    FOREIGN KEY (delivery_id) REFERENCES Deliveries(delivery_id) ON DELETE CASCADE,
    FOREIGN KEY (soi_id) REFERENCES Sales_Order_Items(soi_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE SET NULL,
    INDEX idx_di_delivery (delivery_id),
    INDEX idx_di_product (product_id),
    INDEX idx_di_soi (soi_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Good_Issues (
    issue_id INT AUTO_INCREMENT PRIMARY KEY,
    issue_no VARCHAR(30) UNIQUE NOT NULL,
    delivery_id INT NOT NULL,
    warehouse_id INT NOT NULL,
    issue_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Draft', 'Approved') DEFAULT 'Draft',
    created_by INT,
    approved_by INT,
    approved_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    notes TEXT,
    CONSTRAINT fk_gi_delivery
      FOREIGN KEY (delivery_id) REFERENCES Deliveries(delivery_id) ON DELETE RESTRICT,
    CONSTRAINT fk_gi_warehouse
      FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    CONSTRAINT fk_gi_created_by
      FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_gi_approved_by
      FOREIGN KEY (approved_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_gi_no (issue_no),
    INDEX idx_gi_status (status, deleted_at),
    INDEX idx_gi_delivery (delivery_id),
    INDEX idx_gi_warehouse (warehouse_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Good_Issue_Items (
    gii_id INT AUTO_INCREMENT PRIMARY KEY,
    issue_id INT NOT NULL,
    di_id INT NOT NULL,
    product_id INT NOT NULL,
    issued_qty DECIMAL(18, 2) NOT NULL,
    remark TEXT,
    CONSTRAINT fk_gii_issue
      FOREIGN KEY (issue_id) REFERENCES Good_Issues(issue_id) ON DELETE CASCADE,
    CONSTRAINT fk_gii_delivery_item
      FOREIGN KEY (di_id) REFERENCES Delivery_Items(di_id) ON DELETE RESTRICT,
    CONSTRAINT fk_gii_product
      FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    INDEX idx_gii_issue (issue_id),
    INDEX idx_gii_product (product_id),
    INDEX idx_gii_delivery_item (di_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE AR_Invoices (
    ar_invoice_id INT AUTO_INCREMENT PRIMARY KEY,
    invoice_no VARCHAR(50) UNIQUE NOT NULL,
    customer_id INT NOT NULL,
    so_id INT,
    delivery_id INT,
    invoice_date DATE DEFAULT (CURRENT_DATE()),
    due_date DATE,
    subtotal DECIMAL(18, 2) DEFAULT 0,
    header_discount_percent DECIMAL(5, 2) DEFAULT 0,
    header_discount_amount DECIMAL(18, 2) DEFAULT 0,
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    balance_amount DECIMAL(18, 2) DEFAULT 0,
    status ENUM('Unpaid', 'PartiallyPaid', 'Paid', 'Cancelled') DEFAULT 'Unpaid',
    notes TEXT,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id) ON DELETE RESTRICT,
    FOREIGN KEY (so_id) REFERENCES Sales_Orders(so_id) ON DELETE SET NULL,
    FOREIGN KEY (delivery_id) REFERENCES Deliveries(delivery_id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_ar_invoice_no (invoice_no),
    INDEX idx_ar_status (status, deleted_at),
    INDEX idx_ar_customer (customer_id),
    INDEX idx_ar_due_date (due_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE AR_Invoice_Items (
    ari_id INT AUTO_INCREMENT PRIMARY KEY,
    ar_invoice_id INT NOT NULL,
    soi_id INT,
    di_id INT,
    description VARCHAR(255),
    quantity DECIMAL(18, 2),
    unit_price DECIMAL(18, 2),
    tax_rate DECIMAL(5, 2),
    tax_amount DECIMAL(18, 2),
    line_total DECIMAL(18, 2),
    FOREIGN KEY (ar_invoice_id) REFERENCES AR_Invoices(ar_invoice_id) ON DELETE CASCADE,
    FOREIGN KEY (soi_id) REFERENCES Sales_Order_Items(soi_id) ON DELETE SET NULL,
    FOREIGN KEY (di_id) REFERENCES Delivery_Items(di_id) ON DELETE SET NULL,
    INDEX idx_ari_invoice (ar_invoice_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Customer_Balances (
    balance_id INT AUTO_INCREMENT PRIMARY KEY,
    customer_id INT NOT NULL,
    total_invoiced DECIMAL(18, 2) DEFAULT 0 COMMENT 'Tổng tiền đã xuất hóa đơn',
    total_paid DECIMAL(18, 2) DEFAULT 0 COMMENT 'Tổng tiền đã thanh toán',
    total_credit_note DECIMAL(18, 2) DEFAULT 0 COMMENT 'Tổng tiền Credit Note',
    outstanding_balance DECIMAL(18, 2) DEFAULT 0 COMMENT 'Công nợ còn lại',
    last_updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id) ON DELETE CASCADE,
    UNIQUE KEY uk_customer_balance (customer_id),
    INDEX idx_customer_balance (customer_id),
    INDEX idx_outstanding_balance (outstanding_balance)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE AR_Payments (
    ar_payment_id INT AUTO_INCREMENT PRIMARY KEY,
    ar_invoice_id INT NOT NULL,
    payment_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    amount DECIMAL(18, 2) NOT NULL,
    method VARCHAR(50),
    reference_no VARCHAR(100),
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ar_invoice_id) REFERENCES AR_Invoices(ar_invoice_id) ON DELETE CASCADE,
    INDEX idx_arp_invoice (ar_invoice_id),
    INDEX idx_arp_date (payment_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================================
-- RETURN ORDER & CREDIT NOTE TABLES
-- =====================================================

-- Return Orders Table
CREATE TABLE IF NOT EXISTS return_orders (
    ro_id INT AUTO_INCREMENT PRIMARY KEY,
    return_no VARCHAR(30) UNIQUE NOT NULL,
    delivery_id INT NOT NULL,
    invoice_id INT,
    warehouse_id INT NOT NULL,
    return_date DATETIME,
    status ENUM('Draft', 'Approved', 'Completed', 'Cancelled') DEFAULT 'Draft',
    -- Trạng thái liên quan tới phiếu nhập kho cho đơn trả hàng
    goods_receipt_status ENUM('None','Pending','Completed') DEFAULT 'None',
    receipt_id INT,
    reason TEXT,
    notes TEXT,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (delivery_id) REFERENCES Deliveries(delivery_id) ON DELETE RESTRICT,
    FOREIGN KEY (invoice_id) REFERENCES AR_Invoices(ar_invoice_id) ON DELETE SET NULL,
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    FOREIGN KEY (receipt_id) REFERENCES Goods_Receipts(receipt_id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_return_order_status (status, deleted_at),
    INDEX idx_return_order_delivery (delivery_id),
    INDEX idx_return_order_invoice (invoice_id),
    INDEX idx_return_order_warehouse (warehouse_id),
    INDEX idx_return_order_receipt (receipt_id),
    INDEX idx_return_order_gr_status (goods_receipt_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Sau khi cả Goods_Receipts và return_orders đã tồn tại, thêm ràng buộc FK
ALTER TABLE Goods_Receipts
  ADD CONSTRAINT fk_gr_return_order
  FOREIGN KEY (ro_id) REFERENCES return_orders(ro_id) ON DELETE SET NULL;


-- =====================================================
-- SALES RETURN INBOUND (ĐƠN NHẬP HÀNG LẠI TỪ ĐƠN TRẢ HÀNG)
-- =====================================================

-- Return Inbound Orders: chứng từ thương mại yêu cầu kho nhập lại hàng khách trả
CREATE TABLE IF NOT EXISTS Sales_Return_Inbound_Orders (
    sri_id INT AUTO_INCREMENT PRIMARY KEY,
    sri_no VARCHAR(30) UNIQUE NOT NULL,
    ro_id INT NOT NULL,
    warehouse_id INT NOT NULL,
    expected_receipt_date DATETIME,
    status ENUM('Draft', 'Approved', 'SentToWarehouse', 'Completed', 'Cancelled') DEFAULT 'Draft',
    notes TEXT,
    created_by INT,
    approved_by INT,
    approved_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (ro_id) REFERENCES return_orders(ro_id) ON DELETE CASCADE,
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (approved_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_sri_no (sri_no),
    INDEX idx_sri_status (status, deleted_at),
    INDEX idx_sri_ro (ro_id),
    INDEX idx_sri_warehouse (warehouse_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS Sales_Return_Inbound_Order_Items (
    srii_id INT AUTO_INCREMENT PRIMARY KEY,
    sri_id INT NOT NULL,
    roi_id INT NOT NULL,
    product_id INT NOT NULL,
    warehouse_id INT NOT NULL,
    planned_qty DECIMAL(18, 2) NOT NULL DEFAULT 0,
    uom VARCHAR(50),
    note TEXT,
    FOREIGN KEY (sri_id) REFERENCES Sales_Return_Inbound_Orders(sri_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    INDEX idx_srii_sri (sri_id),
    INDEX idx_srii_roi (roi_id),
    INDEX idx_srii_product (product_id),
    INDEX idx_srii_warehouse (warehouse_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Return Order Items Table
CREATE TABLE IF NOT EXISTS return_order_items (
    roi_id INT AUTO_INCREMENT PRIMARY KEY,
    ro_id INT NOT NULL,
    di_id INT NOT NULL,
    product_id INT NOT NULL,
    warehouse_id INT NOT NULL,
    returned_qty DECIMAL(18, 2) NOT NULL DEFAULT 0,
    uom VARCHAR(50),
    reason TEXT,
    note TEXT,
    FOREIGN KEY (ro_id) REFERENCES return_orders(ro_id) ON DELETE CASCADE,
    FOREIGN KEY (di_id) REFERENCES Delivery_Items(di_id) ON DELETE RESTRICT,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    FOREIGN KEY (warehouse_id) REFERENCES Warehouses(warehouse_id) ON DELETE RESTRICT,
    INDEX idx_return_item_return_order (ro_id),
    INDEX idx_return_item_delivery_item (di_id),
    INDEX idx_return_item_product (product_id),
    INDEX idx_return_item_warehouse (warehouse_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Sau khi return_order_items và Goods_Receipt_Items đã tồn tại, thêm ràng buộc FK
ALTER TABLE Goods_Receipt_Items
  ADD CONSTRAINT fk_gri_return_item
  FOREIGN KEY (roi_id) REFERENCES return_order_items(roi_id) ON DELETE SET NULL;

ALTER TABLE Sales_Return_Inbound_Order_Items
  ADD CONSTRAINT fk_srii_return_item
  FOREIGN KEY (roi_id) REFERENCES return_order_items(roi_id) ON DELETE RESTRICT;

-- Credit Notes Table
CREATE TABLE IF NOT EXISTS credit_notes (
    cn_id INT AUTO_INCREMENT PRIMARY KEY,
    credit_note_no VARCHAR(30) UNIQUE NOT NULL,
    invoice_id INT NOT NULL,
    ro_id INT,
    credit_note_date DATETIME NOT NULL,
    status ENUM('Draft', 'Issued', 'Applied', 'Cancelled') DEFAULT 'Draft',
    reason TEXT,
    notes TEXT,
    subtotal DECIMAL(18, 2) DEFAULT 0,
    header_discount_percent DECIMAL(5, 2) DEFAULT 0,
    header_discount_amount DECIMAL(18, 2) DEFAULT 0,
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    created_by INT,
    updated_by INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (invoice_id) REFERENCES AR_Invoices(ar_invoice_id) ON DELETE RESTRICT,
    FOREIGN KEY (ro_id) REFERENCES return_orders(ro_id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_credit_note_status (status, deleted_at),
    INDEX idx_credit_note_invoice (invoice_id),
    INDEX idx_credit_note_return_order (ro_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Credit Note Items Table
CREATE TABLE IF NOT EXISTS credit_note_items (
    cni_id INT AUTO_INCREMENT PRIMARY KEY,
    cn_id INT NOT NULL,
    product_id INT NOT NULL,
    product_code VARCHAR(50),
    product_name VARCHAR(255),
    uom VARCHAR(50),
    quantity DECIMAL(18, 2) NOT NULL DEFAULT 0,
    unit_price DECIMAL(18, 2) DEFAULT 0,
    discount_amount DECIMAL(18, 2) DEFAULT 0,
    tax_rate DECIMAL(5, 2) DEFAULT 0,
    tax_amount DECIMAL(18, 2) DEFAULT 0,
    line_total DECIMAL(18, 2) DEFAULT 0,
    note TEXT,
    FOREIGN KEY (cn_id) REFERENCES credit_notes(cn_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES Products(product_id) ON DELETE RESTRICT,
    INDEX idx_credit_note_item_credit_note (cn_id),
    INDEX idx_credit_note_item_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- =====================================================
-- REPORTING & LOGGING
-- =====================================================

CREATE TABLE Reports (
    report_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type ENUM('Inventory', 'Sales', 'Purchase', 'Financial') NOT NULL,
    status ENUM('Pending', 'Completed', 'Failed') DEFAULT 'Pending',
    description TEXT,
    report_data JSON,
    generated_by INT,
    generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (generated_by) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_report_type (type),
    INDEX idx_report_status (status),
    INDEX idx_report_date (generated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Activity_Logs (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    action VARCHAR(255) NOT NULL,
    description TEXT,
    activity_type VARCHAR(50),
    entity_id INT,
    ip_address VARCHAR(50),
    device_info VARCHAR(255),
    log_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE SET NULL,
    INDEX idx_log_user (user_id),
    INDEX idx_log_type (activity_type),
    INDEX idx_log_entity (entity_id),
    INDEX idx_log_date (log_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- =====================================================
-- ADDITIONAL INDEXES FOR PERFORMANCE
-- =====================================================

-- Composite indexes for common queries
CREATE INDEX idx_users_department_status_deleted ON Users(department_id, status, deleted_at);
CREATE INDEX idx_products_category_status_deleted ON Products(category_id, status, deleted_at);
CREATE INDEX idx_warehouses_status_deleted ON Warehouses(status, deleted_at);

-- Date range indexes for reporting
CREATE INDEX idx_users_created_range ON Users(created_at);
CREATE INDEX idx_products_created_range ON Products(created_at);
CREATE INDEX idx_purchase_orders_created_range ON Purchase_Orders(created_at);
CREATE INDEX idx_sales_orders_created_range ON Sales_Orders(created_at);

-- Status-based indexes for workflow
CREATE INDEX idx_purchase_orders_approval ON Purchase_Orders(approval_status, status);
CREATE INDEX idx_sales_orders_approval ON Sales_Orders(approval_status, status);

-- Vendor/Customer relationship indexes
CREATE INDEX idx_purchase_orders_vendor_status ON Purchase_Orders(vendor_id, status);
CREATE INDEX idx_sales_orders_customer_status ON Sales_Orders(customer_id, status);

-- Inventory tracking indexes
CREATE INDEX idx_warehouse_stock_product ON Warehouse_Stock(product_id, quantity);

-- Activity logging indexes for audit trails
CREATE INDEX idx_activity_logs_user_date ON Activity_Logs(user_id, log_date);
CREATE INDEX idx_activity_logs_entity_type ON Activity_Logs(entity_id, activity_type);